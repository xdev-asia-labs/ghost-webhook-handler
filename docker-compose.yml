version: "3.8"

services:
  mysql:
    image: mysql:8.0
    container_name: ghost-webhook-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-ghost_webhook}
      MYSQL_USER: ${DB_USER:-ghost}
      MYSQL_PASSWORD: ${DB_PASSWORD:-ghostpassword}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./setup-db.sql:/docker-entrypoint-initdb.d/setup-db.sql
    ports:
      - "3306:3306"
    networks:
      - ghost-webhook-network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${DB_PASSWORD:-rootpassword}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    # Option 1: Use pre-built image from GitHub Container Registry (recommended)
    image: ghcr.io/xdev-asia-labs/ghost-webhook-handler:latest

    # Option 2: Use pre-built image from Docker Hub
    # image: tdduydev/ghost-webhook-handler:latest

    # Option 3: Build locally (uncomment line below and comment images above)
    # build: .

    container_name: ghost-webhook-app
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      SESSION_SECRET: ${SESSION_SECRET:-change-this-secret-key}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USER:-ghost}
      DB_PASSWORD: ${DB_PASSWORD:-ghostpassword}
      DB_NAME: ${DB_NAME:-ghost_webhook}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      FACEBOOK_PAGE_ID: ${FACEBOOK_PAGE_ID:-}
      FACEBOOK_ACCESS_TOKEN: ${FACEBOOK_ACCESS_TOKEN:-}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-}
    ports:
      - "3000:3000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ghost-webhook-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mysql_data:
    driver: local

networks:
  ghost-webhook-network:
    driver: bridge
